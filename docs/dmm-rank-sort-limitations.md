# DMM Affiliate API - sort=rank の制限について

## 確認事項

### 1. sort=rank の制限

DMM Affiliate APIのリファレンスによると：

- **sort=rank**: 人気順でソート
- **hits**: 最大100件（1回のリクエストあたり）
- **offset**: 最大50000（検索開始位置）
- **total_count**: APIが返す総件数（最大50000件まで取得可能）

### 2. 制限の詳細

#### hits（取得件数）
- **最小**: 1件
- **最大**: 100件
- **デフォルト**: 20件

#### offset（検索開始位置）
- **最小**: 1
- **最大**: 50000
- **デフォルト**: 1

#### total_count（総件数）
- APIが返す`total_count`は、検索条件に一致する全件数
- ただし、実際に取得できるのは最大50000件まで

### 3. sort=rank の動作

- **人気順**: 現在の人気が高い順にソート
- **制限**: 特に制限はない（offsetの上限50000まで取得可能）
- **重複**: 同じ作品が複数回返されることはない（通常）

### 4. 実装上の注意点

1. **フィルタ後の件数**
   - 100件取得しても、同人誌フィルタで除外されると実際の件数は少なくなる
   - 例: 100件取得 → 20件除外 → 80件のみ採用
   - 1000件取得するには、実際にはもっと多く取得する必要がある可能性

2. **offsetの増やし方**
   - フィルタで除外される作品があるため、`offset`を単純に100ずつ増やすだけでは不十分
   - 例: `offset=1`で100件取得 → 80件採用 → 次は`offset=101`ではなく、もっと大きくする必要があるかも
   - ただし、API側でフィルタされるわけではないので、`offset`は取得した件数分だけ増やせば良い

3. **総件数の確認**
   - `total_count`で総件数を確認できる
   - ただし、同人誌フィルタを適用すると、実際に取得できる件数は少なくなる

## 結論

**sort=rankに特別な制限はありません。** offsetの上限（50000）まで取得可能です。

ただし、以下の点に注意：
- 1回のリクエストで取得できるのは最大100件
- offsetの上限は50000
- 同人誌フィルタで除外される作品があるため、実際に取得できる件数は少なくなる可能性がある

## 推奨実装

1. **sort=rankで人気順取得**
2. **100件ずつ取得**（hits=100）
3. **offsetを100ずつ増やす**（1, 101, 201, 301...）
4. **同人誌フィルタ適用**
5. **重複チェック**
6. **DBに保存**

この方法で、段階的に1000件、さらに増やすことが可能です。
