# 「女子寮」タグが付かない・消える件（FAQ）

## 対象

- 作品: **女子寮管理人の僕はギャル寮生に振り回されてます4**（workId: `d_448999`）
- 事象: 「女子寮」タグを付けたい／付けたが付いていない／手動で付けても消える

---

## 修正したバグ（Aで追加しても消える場合）

**原因**: GET が A/B/C を `config/tagRanks.json` のランクだけで決めており、**DB には DERIVED で付いていても tagRanks に無いタグは aTags/bTags/cTags に含めていなかった**。  
PUT で `addTagToRanks` が tagRanks.json に書いても、別プロセス・ファイル同期遅れ・書き込み失敗などで GET が古い内容を読むと「女子寮」が返らず、画面で消えて見えていた。

**対応**（コード修正済み）:

1. **GET**: ランク未登録の DERIVED タグを **仮に C として返す**ようにした。DB に付いていれば必ず画面の A/B/C のどれかに出る。
2. **addTagToRanks**: 書き込み失敗時はログを出し、PUT は成功のままにした（タグは DB に残り、GET で C として表示される）。

**いまやること**: 開発サーバーを再起動してから、もう一度「女子寮」を A で追加して保存し、別作品に移動して戻る or ページ更新で確認する。消えていなければ修正が効いている。

---

## 原因として考えられること（優先度順）

### 1. 「女子寮」を **追加S** に入れて保存している（最もありがち）

- **追加S** に含まれる名前は、**公式Sタグ（OFFICIAL）として既に登録されているものだけ** 保存時に反映されます。
- 「女子寮」が公式Sタグに無い場合、追加Sに「女子寮」と入れても **保存時に無視** されます。
- さらに、保存処理は「その作品の DERIVED と 追加S をいったん全削除 → リクエストの additionalSTags / aTags / bTags / cTags だけ付け直す」仕様です。
- そのため「女子寮」は追加Sでは付かず、かつ既存の DERIVED「女子寮」も削除されるため、**結果として女子寮が消えます**。

**対処:**  
「女子寮」は **A / B / C のいずれか**（タグ追加の共通入力で、A/B/C のチップとして）付けてください。

1. タグ追加欄に「女子寮」と入力
2. **Shift+Enter** で「新規として追加」→ 表示された **A / B / C** のどれか（例: A）をクリック
3. 追加Sではなく、**A / B / C のチップ**に「女子寮」が表示されていることを確認してから「保存」

### 2. 保存時に「女子寮」がリクエストに含まれていない

- 人力タグ付けの保存（PUT）は、**送られた aTags / bTags / cTags だけ**を DERIVED として反映する「全置き換え」です。
- 画面上で「女子寮」を付けていても、保存時に **A/B/C のいずれかの配列に「女子寮」が入っていない**と、保存のたびに女子寮は削除されます。
- 例: 別の作品の編集中に「女子寮」を追加したつもりが、保存前に作品が切り替わってフォームが上書きされ、保存時には女子寮が含まれていない、など。

**対処:**  
保存前に、画面右の **A / B / C** のチップ一覧に「女子寮」が **確実に含まれているか** を確認してから「保存」を押す。  
必要ならブラウザの開発者ツールで、保存時の PUT の Request Payload に `aTags` / `bTags` / `cTags` のいずれかに「女子寮」が含まれているか確認する。

### 3. バッチ apply による上書き

- `apply-cursor-legacy-ai-batch.ts` は、対象作品の **DERIVED をいったんすべて削除** し、そのバッチの matchedTags / suggestedTags だけを付け直します。
- この作品（`d_448999`）が、**女子寮を含まない別のバッチ**で後から apply されると、手動で付けた「女子寮」も上書きで消えます。
- `cursor-analysis-untagged-10-batch1.json` には **女子寮** が入っているため、このバッチだけを apply した場合は「女子寮」は付く想定です。

**対処:**  
この作品を含むバッチを apply するときは、**女子寮を含めたタグ一覧**のバッチで実行する（既存の batch1 を使うか、手動追加分も含めたバッチを用意する）。  
apply を複数バッチで行う場合、同じ workId が複数バッチに含まれないようにするか、後から apply するバッチにも「女子寮」を含める。

---

## 仕様の要点

| 項目 | 内容 |
|------|------|
| 人力タグ PUT | その作品の DERIVED / 追加S を全削除 → リクエストの additionalSTags, aTags, bTags, cTags だけ付け直す |
| 追加S | 公式S（OFFICIAL）の displayName と一致する名前のみ反映。一致しない名前は無視される |
| A/B/C | DERIVED タグ。新規の displayName も API 側で Tag 作成の上、WorkTag として保存される |
| バッチ apply | 対象作品の DERIVED を全削除 → そのバッチのタグだけ付け直す（後勝ち） |

---

## この作品とバッチの対応

- **女子寮管理人の僕はギャル寮生に振り回されてます4** は  
  `data/chatgpt-export/cursor-analysis-untagged-10-batch1.json` に **workId: d_448999** で含まれており、**matchedTags に「女子寮」あり**。
- このバッチを apply すれば「女子寮」は付く。  
  その後、女子寮を含まない別バッチで同じ workId を apply すると「女子寮」は消える。

---

## まとめ

- **「女子寮」は追加Sではなく、必ず A/B/C のいずれかで付ける。**
- 保存前に A/B/C のチップに「女子寮」が入っているか確認する。
- バッチ apply は後から実行した内容で上書きされるため、この作品を含むバッチには「女子寮」を含めておく。
