# 仮デプロイ（他人と共有できるURLを用意する）

**目的**: 本番ではなく、仮の状態でサーバーに上げて、**他人がアクセスできるURL** を用意する。

---

## 0. 事前準備（初回 or 環境が変わったとき）

**ここをやっていないと、push しても「Tenant or user not found」など DB エラーが出て、セッション開始ができません。** 必ず確認する。

- [ ] **Postgres（Neon など）**
  - プロジェクトが存在し、停止・削除されていない。
  - 接続文字列（Connection string）をコピーできる状態。
- [ ] **Vercel**
  - 対象プロジェクト → **Settings** → **Environment Variables**
  - **Preview**（および必要なら Production）に次を設定済み:
    - **`DATABASE_URL`**: Postgres の接続文字列（Neon なら「Pooled connection」など）
    - Neon を使う場合: **`DIRECT_URL`** も設定（Prisma の `directUrl` 用）
  - 値を変更した場合は、**Redeploy** が必要なことがある。
- [ ] **動作確認**
  - デプロイ後に、共有用 URL を開き **「AI かどうか？」に答えてセッション開始** まで試し、DB エラーが出ないことを確認する。  
    ここでエラーが出たら → 上記（Postgres 有効・Vercel の環境変数）を見直す。

---

## デプロイできる状態を保つルール（準備）

デプロイ前に必ず守ること。ここを守ると「push したらビルドが通らない」を防げる。

| ルール | 内容 |
|--------|------|
| **スキーマ** | モデルやフィールドを変えたら、**必ず** `prisma/schema.sqlite.prisma` と `prisma/schema.postgres.prisma` の**両方**に同じ変更を入れる。片方だけだとデプロイ時にエラーになる。 |
| **ビルド対象** | ビルドに不要なフォルダ（`backups`・`scripts`）は `tsconfig.json` の `exclude` で除外済み。ここは触らない。 |
| **デプロイ前** | 手順1（コミット）や push の**前**に、必ず **`npm run build`** を実行して成功することを確認する。失敗したら push しない。 |

準備ができてからデプロイする。ビルドが通ってから手順1〜6に進む。

---

## 手順1: 変更を Git に記録する（コミット）

- **やること**: いまの変更を「コミット」という形で記録する。
- **やり方**:  
  「変更をコミットして」と依頼すれば、こちらで実行する。  
  自分でやる場合: プロジェクトフォルダでターミナルを開き、次を実行する。
  ```bash
  git add .
  git commit -m "ここにメッセージ（例: 〇〇の変更）"
  ```
- **注意**: `prisma/dev.db-shm` など DB の一時ファイルはコミットしない（`git add` で必要なファイルだけ選ぶか、`.gitignore` で除外する）。

---

## 手順2: デプロイ前にビルドを通す

- **やること**: **必ず** `npm run build` を実行し、**成功する**ことを確認する。
- **やり方**: ターミナルで `npm run build` を実行する。失敗したら push しない。直してから再度ビルド。

---

## 手順3: サーバー用の設定に切り替えて、それも記録する（prepare:push）

- **やること**: サーバー（Vercel）用の DB 設定（PostgreSQL）に切り替え、その変更もコミットする。
- **やり方**:  
  「Preview用にプッシュ準備して」と依頼すれば、こちらで **`npm run prepare:push`** を実行する。  
  自分でやる場合: ターミナルで **`npm run prepare:push`** を実行する。
- **注意**: このコマンドは **develop ブランチ** でないとエラーで止まる。止まったら、先に **`git checkout develop`** を実行してから、もう一度実行する。

---

## 手順4: GitHub に送る（push）※ここだけあなたが実行

- **やること**: 手順1〜3で記録した内容を GitHub に送る。送ると、Vercel が自動でビルドして **共有用のURL** を作る。
- **やり方**: プロジェクトフォルダでターミナルを開き、次を **あなたが** 実行する。
  ```bash
  git push origin develop
  ```
- GitHub の認証（パスワードやトークン）が求められたら、入力する。
- 終わったら、Vercel のダッシュボードで「develop 用の URL」を確認する。

---

## 手順5: デプロイ後の確認

- **やること**: デプロイが本当に動いているか確認する。**ここで DB エラーが出たら、0. 事前準備（Vercel の DATABASE_URL 等）を見直す。**
- **やり方**:
  1. Vercel のダッシュボードで、該当デプロイが **Success** になっていることを確認する。
  2. 共有用 URL を開き、**「AI かどうか？」に答えてセッション開始** まで試す。
  3. 「Tenant or user not found」など DB エラーが出ないことを確認する。  
     出た場合 → **0. 事前準備** のとおり、Postgres の有効確認と Vercel の **DATABASE_URL**（と Neon なら **DIRECT_URL**）を確認・設定し直す。

---

## 手順6: 手元のPCをまた「ローカル開発用」に戻す（restore:sqlite）

- **やること**: 手順3で「サーバー用」に切り替えた設定を、手元では「ローカル用」（SQLite）に戻す。戻さないと `npm run dev` が動かなくなる。
- **やり方**:  
  「ローカルをSQLiteに戻して」と依頼すれば、こちらで **`npm run restore:sqlite`** を実行する。  
  自分でやる場合: ターミナルで **`npm run restore:sqlite`** を実行する。

---

## まとめ（何をすれば目的が果たせるか）

| 順番 | やること | 誰がやる |
|------|----------|----------|
| 0 | 事前準備（Postgres 有効・Vercel に DATABASE_URL 等を設定・一度デプロイして DB 動作確認） | 初回 or 環境変更時・**あなた** |
| 1 | 変更をコミット | 依頼すればこちら / または自分で `git add .` と `git commit -m "..."` |
| 2 | `npm run build` で成功を確認 | あなた or 依頼 |
| 3 | サーバー用に切り替え＋コミット（prepare:push） | 依頼すればこちらで `npm run prepare:push` / または自分で実行 |
| 4 | GitHub に送る（push） | **あなたが** ターミナルで `git push origin develop` |
| 5 | デプロイ後、URL でセッション開始まで試して DB エラーがないか確認 | **あなた** |
| 6 | 手元をローカル用に戻す（restore:sqlite） | 依頼すればこちら / または自分で `npm run restore:sqlite` |

**あなたが必ず自分でやるのは「手順4: `git push origin develop`」と、初回・環境変更時の「手順0」と「手順5の確認」です。**  
1・2・3・6 は「〇〇して」と依頼してもらえれば、こちらで実行する。

---

## 注意（同じようなミスを防ぐために）

- この手順に **0. 事前準備** と **手順5（デプロイ後の確認）** を入れてあるので、**「DB 接続の前提が手順に無かった」という同じ種類のミス** は起きにくくなる。
- ただし **「絶対に同じようなミスが起きない」「どんな問題も絶対起きない」** とは言い切れない（手順の飛ばし忘れ、Vercel や Neon の仕様変更、別の種類の失敗などがありうる）。
- **手順を丁寧に守り、0 と 5 を毎回確認する** ことで、再現性と信頼性を高める。

---

## 本番環境にデプロイする場合（参考）

他人と共有ではなく「本番」に反映したいときは、ターミナルで次を実行するだけ。

```bash
npm run deploy:prod
```

「本当に本番にデプロイしますか？ yes/no」と出たら **yes** と入力する。
