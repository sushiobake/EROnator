# 旧AIタグ／未タグ タグ付け 指示書

**この指示書だけを読んで実行する。別ファイルは参照しない。**

---

## ゴール（ここができて終わり）

あなたの仕事は、対象作品にタグを付け、**その作品を「チェック待ち」フォルダに移動すること**である。

1. **あなたがタグ付けする**（通常タグ＋**キャラタグ**。commentText に名前が出ていれば characterName に必ず入れる）
2. **あなたが返した JSON でフォルダを移動する**：返した JSON を保存し、`npx tsx scripts/apply-cursor-legacy-ai-batch.ts ファイル名.json` を実行する。これを実行すると、タグがDBに反映され、**対象作品が「チェック待ち」フォルダの先頭に移動する**。ユーザーはそこで確認するだけ。ユーザーは保存も apply もやらない。
3. **apply を実行しないとチェック待ちに一切並ばない。必ず apply まで実行してから終了すること。**

---

**目的**：作品に**正確で差別化できるタグ**（通常タグ＋キャラタグ）を付ける。ユーザーが求める作品にたどり着けるようにする。

---

## 絶対原則（1か所にまとめる）

- **語彙**：タグの displayName は、all-tags API の `s`（公式）または `a`/`b`/`c`（A/B/C）に存在する表記を**そのまま**使う。略語・誤変換・聞き間違いは禁止。公式Sに無い語を additionalSTags に入れない。新規DERIVEDは正しい語で書く（例: 眠姦→睡眠姦、催●→催眠）。
- **重複を避ける**：複合タグ1つで足りるなら「人妻幼馴染」だけ。人妻・幼馴染・人妻幼馴染を3つ並べない。同義語は1つに絞る（ラブホテルとホテルを両方入れない）。
- **視点タグ**：本文に「〇〇視点」と**明記されている場合のみ**付ける。推測で付けない。
- **根拠がなければ付けない**：タイトル・作品コメントに明確な根拠がない場合は、**追加タグは0個で提出してよい**。作者コメントが少ない場合も同様。**曖昧な根拠でタグを付けるより、付けない方がよい。間違ったタグを付けるくらいなら0個の方がよい。**

---

## 毎作品で必ず行うこと（見落とし防止）

以下は**全作品について漏らさず**行う。

1. **タイトルを必ず読む**  
   タイトルに含まれる語（合宿、催眠、オタク、JK、人妻、総集編 など）は**必ず**タグ候補に含める。commentText だけ見てタイトルを見ていないと失敗する。

2. **キャラタグ（characterName）＝タグ付けの一部。必ずやる。**  
   commentText（あらすじ・登場人物など）に**登場人物の名前**が出ていれば、代表1人を characterName に入れる。書いてないときは `null`。作品タイトルはキャラ名ではない。**各オブジェクトに characterName キーを必ず含める。省略禁止。**

3. **シリーズ系タグの確認**  
   タイトルの末尾に**数字（2, 3, 4 など）**や**「続編」「総集編」「編」**がある場合は、**シリーズ系タグ（シリーズもの／続きもの／総集編のいずれか、all-tags で確認）を1つ必ず付ける。** 付け忘れが多いので必ず確認する。

---

## タグ付けの手順（案1：この順で実行する）

各作品について、**次の3段階**で行う。

### ステップ1：既存Sタグを確認する

- その作品に**既に付いている公式Sタグ**（入力に含まれる場合、または all-tags の `s` と照らして把握する）を確認する。
- これらは「前提」であり、**追加で付けるタグは「これ以外」から選ぶ**。

### ステップ2：タイトルを読んでから、既存S以外で1個または2個を探す

- **まずタイトルを読む。** タイトルに出ている語（合宿、催眠、オタク、JK、人妻 など）は**必ず**候補にし、既存Sに無ければ additionalSTags または matchedTags に入れる。タイトルを見ていないとタグ漏れになる。
- 次に作品コメント（commentText）を読み、**既存Sでは表せていない**特徴のうち、**根拠がはっきりしている**ものを1個または2個選ぶ。
- 選んだ語が公式S（all-tags の `s`）にあれば **additionalSTags** に、なければ **matchedTags** に入れる。同じ意味をDERIVEDとSで重複させない。
- **タイトルに数字・続編・総集編・編があれば、シリーズ系タグを1つ付ける**（上記「毎作品で必ず」を参照）。
- **1個も適切なものが無ければ、追加は0個でよい。** 無理に付けない。

### ステップ3：タグを付けたあと、もう一通りコメントを確認する

- ステップ2で追加タグを決めたあと、**作品コメントをもう一度読み**、追加で1個付けられるものがないか探す。あれば加える。なければそのままでよい。
- ここでも**根拠が弱いものは付けない**。0個のままでよい。

### 選び方の優先

- **タイトルに明記されている語**を最優先で候補にする。**タイトルを飛ばさない。**
- あらすじ・プレイ内容・キーワード・嗜好に**列挙されている語**は漏らさない。
- **推測**（「〜の可能性」）では付けない。明記されている場合のみ。
- この作品の**差別化・主軸**になる語（寝取られ、催眠、屈辱、合宿、職業、舞台など）を優先する。

### 提出前チェック（各作品）

JSON を出す前に、その作品について以下を確認する。

- **タイトルからタグを1つ以上取っているか**（タイトルに語があれば必ず候補に入れたか）
- **明確なキャラが書いてあれば characterName に取得したか**（書いてなければ null）
- **タイトルに数字・続編・総集編・編があれば、シリーズ系タグを1つ付けたか**

---

## 参照先（all-tags）

タグの表記は **all-tags**（公式S＝`s`、A/B/C＝`a`/`b`/`c`）に合わせる。コピペの入力には含まれないため、次のいずれかで取得すること。

- **API `GET /api/admin/manual-tagging/all-tags`** を優先する（プロジェクトの管理画面が動いていれば利用可能）。
- APIが使えない場合：Sは `config/officialTagsCache.json`、A/B/Cは `config/tagRanks.json` の `ranks` を参照する。

**additionalSTags** には `s` に載っている displayName のみ。**matchedTags** には、`s` に無い語（A/B/C または新規DERIVED）を入れる。

---

## 付けてよいタグ・付けてはいけないタグ

**付けてよい**：タイトル・あらすじ・プレイ内容・嗜好に**明記**されている語のうち、all-tags と照合して表記を合わせたもの。主軸・差別化になる語を優先。

**付けてはいけない（原則）**  
- 背景だけの語（出張、同窓会、夏休みなど物語の理由だけのもの）  
- メタ情報（続編、後編、Part.1 など形式だけのもの）  
- 汎用語（快楽、性欲、ヒロインなど差別化にならないもの）  
- 主軸でない設定だけ（主軸が催眠なのに「学校」だけ付けるなど）  
- 同義語の重複（ラブホテル＋ホテルは不可）  
- 視点タグ（明記がない限り不可）  
- 曖昧・広義すぎるタグ（彼女あり、元カノなど）

---

## ルール（該当したら適用）

| ルール | 内容 |
|--------|------|
| 推測で付けない | 明記がない限り付けない。「可能性」は不可。 |
| 用語の正確さ | 催●→催眠、眠姦→睡眠姦。筆下ろし＝童貞の初体験。造語・誤用を避ける。 |
| 上位概念 | クラスメイトだけでは高校×。中学・大学もありうるなら「学校」。 |
| シリーズ・総集編 | タイトルや本文に「2」「3」「続編」「総集編」「編」等が明記されていれば、シリーズ系タグを1つ付ける。根拠が無ければ推測で付けない。 |
| タイトル末尾の数字など | **タイトルの末尾に数字（2, 3, 4 など）や「続編」「総集編」「編」がある場合は、シリーズ作品とみなし、シリーズ系タグを1つ付ける。** 人間には当たり前だが、明記がなくてもタイトルだけで判断してよい。 |
| 複合タグのかぶり | 人妻幼馴染・幼馴染・人妻を3つ並べない。複合1つまたは2つまでに絞る。 |
| 意味も一致 | タグ名は表記だけでなく意味も一致させる。バイ≠バイト。 |
| 職業・舞台・強い嗜好 | 本文に明記され、物語の核になっていればタグにする。 |

---

## キャラタグ（characterName）

- **明確なキャラが書いてあるときは取得する。** 登場人物の名前が括弧などで明記されていれば、代表1人だけ入れる。書いてないときは `null`。
- **作品タイトルはキャラ名ではない**。タイトル文字列を characterName に入れない。

---

## 入力件数と出力件数

- **1回の入力は最大100件まで。** 100件を超える場合は分割して依頼すること。
- **返す JSON 配列の件数は、必ず入力の作品数と一致させること。** 1件でも書き漏らすと反映時に不整合になる。出力し終えたら、入力の全 workId が出力に1回ずつ含まれているか照合してから返すこと。

---

## 出力形式（batch JSON）

- 1作品1オブジェクトの**配列**。保存先: **`data/chatgpt-export/`**。ファイル名例: `cursor-analysis-legacy-ai-5-batchNN.json`。
- 各オブジェクト: workId, title, matchedTags, suggestedTags, additionalSTags, **characterName**, tagReasoning（理由を簡潔に）。
- **workId は入力に表示された値そのまま使う。** `cid:` などを付け足したり削ったりしない。
- **characterName は各オブジェクトに必ずキーとして含める。** タグを付ける目的にキャラタグも含まれる。名前が明記されていればその文字列、書いてなければ `null`。省略するとキャラタグが反映されない。

```json
{
  "workId": "d_xxxxxx",
  "title": "作品タイトル",
  "matchedTags": [ { "displayName": "タグ名", "category": "その他" } ],
  "suggestedTags": [ ],
  "additionalSTags": [ "公式タグの表示名" ],
  "characterName": "キャラ名 or null",
  "tagReasoning": { "タイトルから": "…", "あらすじから": "…", "差別化": "…" }
}
```

- **matchedTags**：DERIVEDとして付けるタグ。displayName 必須。category は省略時「その他」でよい。
- **additionalSTags**：公式タグの displayName のみの文字列配列。`s` に無い名前は apply 時にスキップされる。

---

## フォルダを移動するための反映手順（あなたが必ず実行する）

対象作品を**「チェック待ち」フォルダに移動する**ために、次の手順を必ず行う。

1. 返した JSON を **`data/chatgpt-export/`** に保存する。
2. **必ず**以下を実行する（やらないとチェック待ちに並ばず、フォルダは動かない）。

   ```bash
   npx tsx scripts/apply-cursor-legacy-ai-batch.ts <保存したファイル名>.json
   ```

3. 成功すると、タグ・**キャラタグ**がDBに反映され、対象作品が**「チェック待ち」フォルダの先頭に移動する**。ユーザーはそこで確認するだけ。

---

## 既存タグの扱い（legacy_ai / untagged）

- **legacy_ai**：反映時に既存DERIVEDは**すべて削除**され、今回の matchedTags / suggestedTags で**付け直す**。残したい既存タグは matchedTags に同じ displayName で含める。
- **untagged**：もともとDERIVEDが無いので、新規に付けるだけ。

---

## 指示書の更新のしかた

チェックで新しいパターンが判明したら、**「ルール」表に1行追加**する。個別の作品名や事例の列挙は増やさない。判断の軸は常にルール表に置く。人間には当たり前だがAIには伝わりにくいことは、ルールとして短く書く（例: タイトル末尾の数字→シリーズ）。

---

*この指示書は1本で完結させる。運用とともにルールを追加し、90点に近いタグ付けを目指す。*
