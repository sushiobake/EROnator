# 準有名タグ生成バッチ処理 - ガイド

## 概要

1⃣～4⃣の処理を自動実行するバッチ処理システムです。

1. **1⃣**: 最新100件の作品を取得（DBから）
2. **2⃣**: それらのURLを取得
3. **3⃣**: スクレイピングで作品コメントを取得（Puppeteer使用）
4. **4⃣**: AIで準有名タグを生成してDBに保存

## 使用方法

```bash
# デフォルト（最新100件）
npm run generate:derived-tags

# 件数を指定
npm run generate:derived-tags -- --limit=50
```

## 処理の流れ

### 1⃣ 最新100件の作品を取得

- DBから最新100件の作品を取得（`createdAt`降順）
- `workId`, `title`, `productUrl`を取得

### 2⃣ URLを取得

- 各作品の`productUrl`を取得

### 3⃣ スクレイピングで作品コメントを取得

- Puppeteerを使用してFANZAの年齢確認を突破
- 各作品の詳細ページから作品コメントを抽出
- レート制限対策: リクエスト間に2秒の遅延

### 4⃣ AIで準有名タグを生成してDBに保存

- Hugging Face APIを使用して準有名タグを生成
- 生成されたタグを`Tag`テーブルに保存（`tagType='DERIVED'`）
- `WorkTag`テーブルに`derivedConfidence`を保存
- レート制限対策: AIリクエスト間に3秒の遅延

## システムプロンプト

現状のシステムプロンプトを使用（後から調整可能）:

```
あなたは成人向け同人誌のタグ生成AIです。
作品コメントを読み、その作品に適した「準有名タグ」を生成してください。

準有名タグとは:
- 公式タグ（OFFICIAL）には含まれていないが、作品の特徴を表すタグ
- シチュエーション、属性、関係性などを表現する
- 例: 「温泉」「学園」「年上」「年下」「先輩後輩」など

出力形式（JSON）:
{
  "derivedTags": [
    {
      "displayName": "タグ名",
      "confidence": 0.0-1.0の数値,
      "category": "カテゴリ名（例: シチュエーション、属性、関係性）"
    }
  ],
  "characterTags": ["キャラクター名1", "キャラクター名2"]
}

注意:
- derivedTagsは最大5件まで
- characterTagsは最大1件まで
- 既存の公式タグと重複しないようにする
- 作品コメントから読み取れる情報のみを使用する
```

## 環境変数

以下の環境変数が必要です:

- `HUGGINGFACE_API_TOKEN`: Hugging Face APIトークン
- `DATABASE_URL`: データベース接続URL（通常は自動設定）

## 出力

処理中に以下の情報が表示されます:

- 各ステップの進捗状況
- 成功/スキップ/エラーの件数
- 生成された準有名タグの数

## 注意事項

1. **処理時間**: 100件の処理には数時間かかる可能性があります（スクレイピングとAI処理のため）
2. **レート制限**: リクエスト間に遅延を設けていますが、必要に応じて調整してください
3. **エラーハンドリング**: エラーが発生しても処理は続行されます（スキップとしてカウント）

## システムプロンプトの調整

システムプロンプトは`scripts/generate-derived-tags-batch.ts`の`SYSTEM_PROMPT`定数を編集することで調整できます。
