# Sタグ（OFFICIAL）の重複防止と禁止タグ

更新: 2026-01-27

---

## 1. 問題：同名Sタグの重複（カテゴリ違い）

同一の **表示名** で **カテゴリだけ違う** Sタグが2つ存在することがある。

例:
- 「おやじ」 1件 / **キャラクター**
- 「おやじ」 3件 / **ジャンル**

**原因**: API（DMM等）取得時に「ジャンル」としてタグを登録しているため。片方は手動・別経路で「キャラクター」等で作られ、もう片方はAPIの `iteminfo.genre` から `category: 'ジャンル'` で作られる。  
`tagKey` は `displayName` のハッシュで決まるが、過去の別系統インポートや正規化差で同一名でも別 `tagKey` が存在することがある。

**方針**:
- **統合時は「ジャンルじゃない方」を正とする**  
  例: 「おやじ」ならキャラクター側を残し、ジャンル側の WorkTag をすべて正タグに移し、ジャンル側タグを削除する。
- 既存の統合スクリプト: `scripts/merge-genre-tags.js`（`--dry-run` で確認後、本実行）。  
  重複が再発した場合は同スクリプトで再度統合する。

---

## 2. 二度と重複させないためのルール

### 2.1 API取得時に「カテゴリ」を取得・設定しない

- DMM API の `iteminfo.genre` は「Sタグの名前」だけ使う。
- DB の Tag には **category を保存しない**（OFFICIAL は `category: null` とする）。  
  これにより「ジャンル」というカテゴリで別扱いになることを防ぐ。

### 2.2 Sタグは「名前のみ」で解決する

- 既存 OFFICIAL タグへの紐付けは **displayName のみ** で行う。
- 同名の OFFICIAL が複数ある場合は **「ジャンル」でない方** を優先して使用する（解決用ヘルパーで実装）。

### 2.3 Sタグの新規作成をしない（既存のみ紐付け）

- **Sタグ（OFFICIAL）は「すでにDBにあるものだけ」を使う。**
- API 取得で新しいタグ名が出てきても **新規 Tag は作らない**。  
  既存の OFFICIAL がいる場合だけ WorkTag を追加する。いない場合はスキップする。
- これにより「勝手にSタグが増える」ことを防ぎ、同名・別カテゴリの重複も発生しなくする。

実装箇所:
- `scripts/import-dmm-batch.ts` … genre から OFFICIAL を付けるとき、既存のみ紐付け・category なし。
- `scripts/import-from-json.ts` … 同様。
- `src/server/admin/importToDb.ts` … OFFICIAL は既存のみ紐付け、新規作成しない。

---

## 3. 禁止タグ（取得禁止タグ）

作品の特徴ではないタグ（イベント名・販促・フラグ等）は **表示・質問には使わず**、「取得禁止タグ」として扱う。

- **定義**: `config/bannedTags.json` の `bannedTags` にパターン登録。
- **挙動**:
  - インポート時: その名前の OFFICIAL は **付与しない**（スキップ）。  
    既に DB に付いている禁止タグは別スクリプト（`scripts/remove-official-banned-tags.ts` 等）で削除可能。
  - 表示・質問: 禁止タグはゲーム・管理画面の「質問に使うタグ」には含めない（既に bannedTags でフィルタしている想定）。

### 登録済みの例（作品の特徴でないもの）

- COMITIA154
- NEW(AI)サークル
- NEWサークル
- がんばろう同人！
- マスト作品
- 広告掲載作品
- 初回購入作品

これらは「削除」ではなく **禁止タグリストに入れ、今後も自動取得で同じタグが来たら禁止扱いにする**。

---

## 4. 運用メモ

- 同名Sタグの重複がまた出た場合は、`merge-genre-tags.js` で「ジャンル」→ 他カテゴリへ統合。
- 新しい「作品の特徴でないタグ」が出てきたら、`config/bannedTags.json` に追加し、管理画面の「取得禁止タグ管理」でも確認する。
