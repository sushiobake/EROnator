# DMM API ランキング変動の分析

## 問題提起

**`sort=rank`で取得しているが、これは「その時刻とともに変動する」のではないか？**

もしそうなら、順位の数字が変わる可能性があり、「漏らす」可能性もある。

## 分析

### 1. `sort=rank`の仕様

DMM APIの`sort=rank`は「現在の人気順」を返します。これは：
- **リアルタイムの人気度**に基づく
- **時刻とともに変動する**可能性が高い
- **購入数、レビュー数、アクセス数**などが反映される

### 2. 変動の影響

#### 問題点
1. **取得漏れのリスク**
   - 時刻T1でoffset=1-100を取得
   - 時刻T2でoffset=101-200を取得
   - この間に順位が変動すると、T1で取得した作品がT2ではoffset=101-200の範囲外になる可能性
   - 逆に、T1で取得しなかった作品がT2でoffset=1-100に入る可能性

2. **重複取得のリスク**
   - 同じ作品が異なるoffsetで取得される可能性
   - ただし、これは`workId`で重複チェックしているため問題なし

3. **取得順序の不確定性**
   - 同じoffsetでも、取得時刻によって異なる作品が返される可能性

### 3. 実際の影響度

#### 高リスク
- **長時間かかる取得**（1000件以上）
- **複数回に分けた取得**（1日おきなど）

#### 低リスク
- **短時間での一括取得**（100件程度）
- **連続した取得**（offset=1, 101, 201...を短時間で）

### 4. 対策案

#### 案1: 取得時刻を記録（推奨）
- 各作品に「取得時刻」を記録
- 同じoffset範囲で複数回取得し、差分を確認
- 漏れが発生した場合、後から補完可能

#### 案2: 重複チェックの強化
- 既に実装済み（`workId`で重複チェック）
- ただし、これは「漏れ」を防げない

#### 案3: 取得範囲のオーバーラップ
- offset=1-100, 91-190, 181-280...のように重複させて取得
- 漏れを最小化できるが、処理時間が増える

#### 案4: 固定スナップショットの利用（理想だが不可能）
- DMM APIには「過去のランキングスナップショット」機能がない
- 年別ランキングもAPIでは取得不可

### 5. 推奨アプローチ

#### 短期的（100件テスト）
- **現状の方法で問題なし**
- 短時間での取得のため、変動の影響は小さい
- 重複チェックで保護されている

#### 中期的（1000件取得）
- **取得時刻を記録**（`createdAt`で既に記録済み）
- **取得ログを保存**（どのoffsetで何件取得したか）
- **定期的な再取得**で漏れを補完

#### 長期的（継続的な取得）
- **取得戦略の見直し**
  - `sort=date`（発売日順）と組み合わせる
  - 特定の期間（例：2021年）に絞り込む
  - ジャンルやタグで絞り込む

### 6. 検証方法

1. **同じoffsetで2回取得**し、差分を確認
2. **取得間隔を変えて**（1時間後、1日後）同じoffsetで取得し、変動を確認
3. **取得ログを分析**し、実際の変動率を測定

## 結論

- **`sort=rank`は確かに時刻とともに変動する**
- **短時間での取得（100件程度）では影響は小さい**
- **長時間かかる取得や複数回に分けた取得では、漏れのリスクがある**
- **対策として、取得時刻の記録と取得ログの保存を推奨**
