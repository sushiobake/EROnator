# DMM APIデータ取得・インポートの流れ

## 現在の状況確認

まず、DBの状態を確認してください：

```bash
npm run check:db-status
```

このコマンドで以下が確認できます：
- 総作品数
- 最新5件（1ページ目に表示される）
- 最古5件
- API取得データの有無（contentIdがあるかどうか）

## データの保存場所

### 1. JSONファイル（一時保存）
- 場所: `data/dmm-api-test/`
- 用途: API取得時のレスポンスを保存（バックアップ）
- 例: `itemlist_2026-01-26T17-59-05.json` (90件)

### 2. データベース（本番データ）
- 場所: `prisma/dev.db`
- 用途: アプリケーションで使用する実際のデータ
- 管理者画面で表示されるのはこちら

## データの流れ

### パターン1: APIから直接取得 → DB保存
```bash
# 1. APIから100件取得してDBに保存
npm run import:dmm-batch -- --target=100

# 2. 確認
npm run check:db-status
```

**メリット:**
- 最新データを取得できる
- 重複チェックが自動

**デメリット:**
- API呼び出しが必要（時間がかかる）
- レート制限の可能性

### パターン2: JSONファイルからインポート
```bash
# 1. 開発サーバーを停止（Ctrl+C）

# 2. JSONファイルからインポート
npm run import:from-json -- data/dmm-api-test/itemlist_2026-01-26T17-59-05.json

# 3. 開発サーバーを再起動
npm run dev:clean

# 4. 確認
npm run check:db-status
```

**メリット:**
- 高速（API呼び出し不要）
- 同じデータを何度でもインポート可能

**デメリット:**
- 既にDBに入っている場合はスキップされる（重複チェックあり）

## 今後の推奨フロー

### 初回セットアップ（100件テスト）
1. **APIから直接取得**（推奨）
   ```bash
   npm run import:dmm-batch -- --target=100
   ```
   - 最新データを取得
   - 重複チェック自動
   - DBに直接保存

2. **確認**
   ```bash
   npm run check:db-status
   ```

3. **管理者画面で確認**
   - `http://localhost:3000/admin/tags`
   - 「DBから読み込み」をクリック
   - 1ページ目に最新100件が表示される

### 追加取得（1000件など）
同じコマンドで追加取得可能：
```bash
npm run import:dmm-batch -- --target=1000
```
- 既存データはスキップ（重複チェック）
- 新規データのみ追加

### JSONファイルからの復元
もしAPI取得に失敗した場合、JSONファイルから復元可能：
```bash
# 開発サーバーを停止してから
npm run import:from-json -- data/dmm-api-test/ファイル名.json
```

## ページネーションについて

管理者画面は**新しい順（createdAt DESC）**で表示されます：
- **1ページ目**: 最新100件（最新に取得したデータ）
- **2ページ目**: 101-200件目
- **3ページ目**: 201-300件目
- ...

つまり、新しく取得したデータは自動的に1ページ目に表示されます。

## よくある質問

### Q: 100件のデータは保存されているか？
A: `npm run check:db-status`で確認できます。`contentId`が設定されている作品があれば、API取得データです。

### Q: もう一度取得した方がいいか？
A: 
- **既にDBに入っている場合**: 不要（重複チェックでスキップされる）
- **DBに入っていない場合**: 必要
- **JSONファイルがある場合**: JSONからインポートする方が高速

### Q: JSONファイルとDBの違いは？
A:
- **JSONファイル**: APIレスポンスのバックアップ（一時保存）
- **DB**: アプリケーションで使用する実際のデータ

JSONファイルからインポートすると、DBに保存されます。

## トラブルシューティング

### DBがロックされている
```bash
# 開発サーバーを停止（Ctrl+C）
# その後、インポートコマンドを実行
```

### データが表示されない
1. `npm run check:db-status`でDBの状態を確認
2. 管理者画面で「DBから読み込み」をクリック
3. ページネーションを確認（1ページ目に最新データ）

### 重複データが気になる
`npm run check:imported`で重複チェックができます。
